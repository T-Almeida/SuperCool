<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js - platformer demo</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body>

<div id="container"></div>
<script src="threejs/three.js"></script>
<script src="threejs/PointerLockControls.js"></script>

<script src="utils.js"></script>

<script src="scene.js"></script>
<script src="bullet.js"></script>
<script src="player.js"></script>



<script>

    var container = document.getElementById("container");

    var havePointerLock = 'pointerLockElement' in document || 'mozPointerLockElement' in document || 'webkitPointerLockElement' in document;

    //verificar se o browser suporta pointerLock
    if ( havePointerLock ) {

        var element = document.body;

        // Hook pointer lock state change events
        document.addEventListener( 'pointerlockchange', pointerlockchange, false );
        document.addEventListener( 'mozpointerlockchange', pointerlockchange, false );
        document.addEventListener( 'webkitpointerlockchange', pointerlockchange, false );


        container.addEventListener( 'click', function ( event ) {

            // Ask the browser to lock the pointer
            element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;
            element.requestPointerLock();

        }, false );

    } else {

        container.innerHTML = 'Your browser doesn\'t seem to support Pointer Lock API';

    }


    window.addEventListener( 'resize', resize, false );
    resize();

    document.getElementById( 'container' ).appendChild( renderer.domElement );


    //CRIAR OBJETOS
    objetos = [];
    bullets = []; // array separado para acelerar as colisoes

    var objPlayer = new Player();
    objetos.push(objPlayer);

    //BIDING EVENTOS
    var pause = false;
    //keyDown
    document.addEventListener('keydown', function (event) {
        switch (event.keycode){
            case 80:
                pause = !pause;
                break;
        }
        objPlayer.onKeyDown(event);//keyDown do player

    } , false);
    //keyUp
    document.addEventListener('keyup', function (event) {
        objPlayer.onKeyUp(event);//keyUp do player
    } , false);
    //mouse down
    document.addEventListener( 'mousedown', function () {
        console.log("mouse down");
        objPlayer.mousedown();
    }, false );

    //mouse up
    document.addEventListener( 'mouseup', function () {
        objPlayer.mouseup();
    }, false );

    //FIM BINDING EVENTOS

    //CALL create e ADICIONAR OBJETOS AO CENARIO
    for (var i = 0 ; i < objetos.length ; i++){
        objetos[i].draw();
        objetos[i].create();
    }

    var prevTime = performance.now();
    function gameLoop() {
        var time = performance.now();
        var delta = ( time - prevTime ) / 1000;

        resetPlayer();
        if (!pause ) {
            //Call update
            for (var i = 0 ; i < objetos.length ; i++){
                objetos[i].update(delta);
            }
            for (var i = 0 ; i < bullets.length ; i++){
                bullets[i].updateBullet(delta,i);
            }
        }
        prevTime = time;

        console.log("Objs em cena " + scene.children.length);

        requestAnimationFrame( gameLoop );
        renderer.render( scene, camera );

    }



    gameLoop();

</script>
</body>
</html>